# Script Files Guide

## Overview

Papyrus scripts in Fallout 4 use multiple file formats throughout their lifecycle, from source code to compiled executable. Each file type serves a distinct purpose in the development and execution pipeline.

**File Extensions Reference**
| Extension | Name | Purpose | Editable |
|-----------|------|---------|----------|
| `.psc` | Papyrus Source Code | Human-readable script source | Yes |
| `.pas` | Papyrus Assembly | Intermediate assembly representation | No |
| `.pex` | Papyrus Executable | Compiled runtime binary | No |
| `.ppj` | Papyrus Project | Build configuration and settings | Yes |
| `.log` | Log File | Runtime debug/error information | No |

---

## File Types

### Source: .psc Files

**Purpose**: Human-readable Papyrus source code files.

**Description**
Contains the actual script code written by developers. These are plain text files with Papyrus syntax.

**Characteristics**
- Plain text format
- Human-readable and editable
- Contains functions, properties, events, and script structure
- Can include comments for documentation
- Subject to compile-time type checking and syntax validation

**Location**: Typically stored in `Data\Scripts\Source\` directory

**Example Structure**
```papyrus
Scriptname MyScript extends Actor

; Property definitions
Int myInt = 5
Float myFloat = 1.5

; Event handler
Event OnInit()
    ; Initialization code
EndEvent

; Custom function
Function DoSomething()
    myInt = myInt + 1
EndFunction
```

**Workflow**
1. Edit .psc files in Creation Kit or external text editor
2. Compile via Papyrus Compiler to produce .pex
3. Game loads .pex files at runtime
4. Keep .psc in version control; distribute .pex to users

---

### Assembly: .pas Files

**Purpose**: Intermediate Papyrus assembly representation (compiler output before .pex generation).

**Description**
Generated by the Papyrus Compiler as an intermediate step between source and executable. Rarely used by most developers; primarily useful for advanced debugging or compiler optimization analysis.

**Characteristics**
- Intermediate bytecode representation
- Generated automatically during compilation
- Not directly editable (regenerated on each compile)
- More human-readable than binary .pex but lower-level than .psc
- Useful for understanding compiler behavior or optimizations

**Location**: Generated in the same directory as .pex output

**When Used**
- Debugging complex compiler issues
- Analyzing optimization passes
- Understanding stack operations or bytecode generation
- Performance profiling with specialized tools

**Note**: Most developers never need to examine .pas files; they're primarily for compiler development and advanced optimization analysis.

---

### Executable: .pex Files

**Purpose**: Compiled binary executable format loaded and executed by Fallout 4.

**Description**
The final compiled format that the game engine understands. Generated by the Papyrus Compiler from .psc source files. These are binary files not intended for human editing.

**Characteristics**
- Binary compiled format
- Not human-readable (bytecode)
- Contains optimized script logic from .psc source
- Includes metadata (property info, function definitions, etc.)
- Loaded directly by game engine at runtime
- Version-dependent (tied to game version and script compilation settings)

**Location**: `Data\Scripts\` directory (game-side)

**Generation**
Produced by running:
```
PapyrusCompiler MyScript.psc -i="Data\Scripts" -o="Data\Scripts"
```

**Distribution**
- Distribute .pex files to users (not source .psc)
- Include in mod packages for release
- Never manually edit .pex files
- Always recompile from .psc source if changes needed

**Runtime**
- Game loads .pex files on startup or when scripts are attached
- Script instances run with .pex bytecode
- Performance depends on optimization flags used during compilation

---

### Project: .ppj Files

**Purpose**: Papyrus build configuration and project settings.

**Description**
XML-based project files that define compilation settings, import paths, output directories, optimization flags, and other build parameters. Simplifies repeated compilation with consistent settings.

**Characteristics**
- XML text format
- Editable configuration file
- Contains compiler settings and paths
- Allows preset build configurations
- Command-line arguments can override project settings

**Typical Locations**
- Root of project directory
- Alongside source scripts
- In mod development folders

**Basic Structure**
```xml
<?xml version="1.0" encoding="utf-8"?>
<Project>
  <Include>Data\Scripts</Include>
  <Include>Data\Scripts\Source</Include>
  <Flags>Institute_Papyrus_Flags.flg</Flags>
  <Output>Data\Scripts</Output>
  <Optimize>true</Optimize>
  <Release>false</Release>
  <Final>false</Final>
</Project>
```

**Configuration Elements**

| Element | Purpose | Example |
|---------|---------|---------|
| `<Include>` | Search path for scripts (multiple allowed) | `<Include>Data\Scripts</Include>` |
| `<Flags>` | Flag file for conditionals | `<Flags>Institute_Papyrus_Flags.flg</Flags>` |
| `<Output>` | Output directory for .pex files | `<Output>Data\Scripts</Output>` |
| `<Optimize>` | Enable optimizations (true/false) | `<Optimize>true</Optimize>` |
| `<Release>` | Remove debugOnly calls (true/false) | `<Release>true</Release>` |
| `<Final>` | Remove betaOnly calls (true/false) | `<Final>true</Final>` |

**Usage**
```
PapyrusCompiler MyProject.ppj
```

Command-line arguments override project settings:
```
PapyrusCompiler MyProject.ppj -r -op
```

**Advantages**
- Consistent build settings across team members
- Less typing for repeated compilations
- Version control project configuration
- Easy switching between debug/release builds
- Simplifies batch compilation scripts

**See Also**: Resource:Creation Kit/Papyrus Projects (detailed reference)

---

### Log: .log Files

**Purpose**: Runtime debug and error information logged during script execution.

**Description**
Text log files generated by Papyrus scripts at runtime. Used for debugging script behavior and capturing runtime errors, warnings, and custom debug messages.

**Characteristics**
- Plain text format
- Generated during game runtime
- Contains timestamps, script names, and messages
- Cumulative (appended across multiple game sessions)
- Can grow large in long sessions

**Location**: 
- `My Games\Fallout4\Logs\Script\` (user logs during gameplay)
- Custom locations specified in script logging calls

**Content Types**

| Log Type | Source | Example |
|----------|--------|---------|
| Errors | Compiler/Runtime | `Error in function MyFunction: Type mismatch` |
| Warnings | Runtime | `Warning: Property not initialized` |
| Debug Messages | Custom (Debug.Notification, etc.) | `Debug output from MyScript` |
| Stack Traces | Errors | Function call stack on error |
| Performance Info | Runtime | Execution times, memory usage |

**Example Log Entry**
```
[01/24/2026 - 14:30:22] MyScript: Initializing actor
[01/24/2026 - 14:30:23] MyScript: Setting property to 5
[01/24/2026 - 14:30:24] Error in MyScript.DoSomething(): Type mismatch
```

**Accessing Logs**
1. **In-Game Console**: Use commands to view/write logs
2. **Log File Directly**: Browse to Logs\Script\ folder
3. **Debug Messages**: Use Debug utility functions
4. **Papyrus Stack Dump Analyzer**: Analyze complex stack traces

**Creating Log Entries**

Scripts can write to logs using Debug functions:
```papyrus
Debug.Notification("Message shown to player")
Debug.MessageBox("Modal popup message")
Debug.Trace("Message logged to Papyrus log")
```

**Log Management**
- Logs accumulate across sessions; periodically clean old logs
- Large logs impact game startup performance
- Use meaningful debug messages for troubleshooting
- Remove excessive logging before release

---

## Tooling

### Creation Kit

The main editor for script creation and management.

**Features**
- Built-in script editor with syntax highlighting
- Papyrus Manager for script organization
- Auto-compilation with error reporting
- Debug output console
- Script search and indexing

**Integration**: Uses Papyrus Compiler internally for all compilations.

---

### Text Editors

**Supported External Editors**
- Visual Studio Code (with Papyrus extensions)
- Sublime Text (with Papyrus syntax packages)
- Notepad++ (with Papyrus language definitions)
- Any text editor with syntax highlighting support

**Advantages Over Creation Kit**
- Lightweight and fast
- Better code organization (multiple files, projects)
- Advanced search and refactoring
- Version control integration
- Custom build tasks

**Workflow**: Edit in external editor → compile with Papyrus Compiler → test in Creation Kit or game

**VS Code Integration Example**
```json
{
  "editor.formatOnSave": true,
  "editor.wordWrap": "on",
  "[papyrus]": {
    "editor.defaultFormatter": "joelday.papyrus",
    "editor.formatOnSave": true
  }
}
```

See **Resource:Creation Kit/Text Editors** for detailed setup.

---

### Papyrus Compiler

Command-line utility for compiling .psc to .pex.

**Key Features**
- Batch compilation of multiple scripts
- Optimization and release build modes
- Custom import paths and output directories
- Quiet mode for automation
- Project file support

**Basic Usage**
```
PapyrusCompiler MyScript.psc -i="Data\Scripts" -o="Data\Scripts"
```

**Typical Flags**
- `-i="<path>"`: Import/search paths (semicolon-separated)
- `-o="<path>"`: Output directory for .pex files
- `-f="<file>"`: Flag file (usually `Institute_Papyrus_Flags.flg`)
- `-r`: Release mode (remove debugOnly calls)
- `-op`: Optimize script
- `-a`: Compile all scripts in folder
- `-q`: Quiet output

**See Also**: PAPYRUS_COMPILER_GUIDE.md (comprehensive reference)

---

### Papyrus Assembler

Converts .pex binary back to human-readable assembly format.

**Purpose**
- Disassembling compiled scripts for analysis
- Debugging compiler output
- Understanding optimized bytecode

**Usage**
```
PapyrusAssembler MyScript.pex > MyScript.pas
```

**When Used**
- Analyzing compiler optimizations
- Reverse engineering compiled scripts
- Debugging complex runtime issues
- Performance profiling

---

### Papyrus Profile Analyzer

Analyzes script performance and execution profiling data.

**Features**
- Runtime performance metrics
- Function call statistics
- Memory usage tracking
- Optimization recommendations

**Output**
- Call frequency statistics
- Execution time per function
- Bottleneck identification
- Memory allocation profiles

**Usage**: Capture profiling data during gameplay, then analyze with this tool.

---

### Papyrus Stack Dump Analyzer

Analyzes stack traces from script errors and exceptions.

**Purpose**
- Parse complex stack traces from log files
- Identify error locations and call chains
- Correlate errors to source code

**Input**: Stack trace from Papyrus .log file

**Output**: Formatted, readable stack trace with function names and line references

**Workflow**
1. Encounter error in game (visible in console or log)
2. Copy stack trace from Papyrus.log
3. Run through Stack Dump Analyzer
4. Review formatted output to identify error source

---

## Workflow Summary

### Development Cycle

1. **Edit Source** (.psc)
   - Create/modify scripts in Creation Kit or external editor
   - Version control source files

2. **Compile** (.psc → .pex)
   - Use Papyrus Compiler (manually or via IDE)
   - Verify no compilation errors
   - Optional: Examine .pas intermediate assembly

3. **Test**
   - Load compiled .pex in game
   - Review Papyrus.log for runtime errors
   - Use Papyrus Stack Dump Analyzer if needed

4. **Debug** (if errors)
   - Add Debug.Trace() calls for diagnostics
   - Recompile and test
   - Use Papyrus Profile Analyzer for performance issues

5. **Optimize**
   - Compile with `-op -r` flags for release
   - Remove debugOnly/betaOnly function calls
   - Verify performance

6. **Release**
   - Distribute .pex files (not .psc source)
   - Include in mod packages
   - Document in changelog

### File Lifecycle

```
┌─────────────────────────────────────────────┐
│  Edit .psc (source)                         │
│  ↓                                          │
│  Papyrus Compiler                           │
│  ├─ .pas (assembly, intermediate)          │
│  └─ .pex (executable, runtime binary)      │
│      ↓                                      │
│  Fallout 4 Engine                           │
│  ├─ Load .pex at startup/script attach     │
│  ├─ Execute bytecode                        │
│  └─ Write errors/debug to .log file        │
│      ↓                                      │
│  Review .log, analyze with tools            │
│  ├─ Stack Dump Analyzer (errors)            │
│  ├─ Profile Analyzer (performance)          │
│  └─ Return to source edits (step 1)         │
└─────────────────────────────────────────────┘
```

---

## Best Practices

### Source Control (.psc)
- **Version Control**: Always commit .psc source files
- **Ignore**: Add .pex, .pas, .log to .gitignore
- **Branches**: Use branches for feature development
- **Comments**: Document complex logic in .psc source

### Project Files (.ppj)
- **Share**: Commit .ppj to version control
- **Consistency**: Ensures all developers use same build settings
- **Presets**: Create multiple .ppj files for dev/release builds

### Compilation
- **Debug Builds**: Compile without `-r -op` during development
- **Release Builds**: Always use `-r -op -final` for distribution
- **Batch Mode**: Use `-a -q` flags for faster compilation of many scripts

### Logging (.log)
- **Meaningful Messages**: Use descriptive Debug.Trace() calls
- **Cleanup**: Remove excessive logging before release
- **Performance**: Disable or minimize logging in released scripts

### Tooling
- **Consistent Environment**: Use same Papyrus version across team
- **Automated Builds**: Use project files and batch scripts for consistency
- **Text Editor Setup**: Configure syntax highlighting and build tasks

---

## Related Resources

- **Resource:Creation Kit/Script File Structure**: Detailed Papyrus syntax and structure
- **Resource:Creation Kit/Papyrus Projects**: Project configuration reference
- **PAPYRUS_COMPILER_GUIDE.md**: Compiler command-line reference
- **Resource:Creation Kit/Text Editors**: External editor setup
- **Resource:Creation Kit/Papyrus Assembler**: Assembly format and disassembly
- **Resource:Creation Kit/Papyrus Profile Analyzer**: Performance profiling
- **Resource:Creation Kit/Papyrus Stack Dump Analyzer**: Error analysis

---

## Quick Reference

**File Type Checklist**

| Task | File Type | Action |
|------|-----------|--------|
| Write/edit code | .psc | Edit in Creation Kit or text editor |
| Compile scripts | .psc | Use PapyrusCompiler.exe |
| Include in game | .pex | Place in Data\Scripts\ |
| Configure build | .ppj | Edit XML with build settings |
| Debug errors | .log | Review in Papyrus.log or Logs\Script\ |
| Analyze assembly | .pas | Generated by compiler (rarely needed) |
| Version control | .psc | Commit to Git/version control |
| Distribute to users | .pex | Package in mod archive |

**Common Commands**

```powershell
# Single script (development)
PapyrusCompiler MyScript.psc -i="Data\Scripts" -o="Data\Scripts" -f="Institute_Papyrus_Flags.flg"

# Single script (release)
PapyrusCompiler MyScript.psc -i="Data\Scripts" -o="Data\Scripts" -f="Institute_Papyrus_Flags.flg" -r -op

# Entire folder (batch)
PapyrusCompiler Data\Scripts -i="Data\Scripts" -o="Data\Scripts" -f="Institute_Papyrus_Flags.flg" -a -q

# With project file
PapyrusCompiler MyProject.ppj -r -op
```
